<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resultados</title>
    <style>
      :root {
        --bg: #f2f0ea;
        --accent: #1f4e5f;
        --accent-dark: #153844;
        --card: #ffffff;
        --shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Georgia", "Times New Roman", serif;
        background: radial-gradient(circle at top, #fff8e8 0%, var(--bg) 45%);
        display: flex;
        justify-content: center;
        color: #1b1b1b;
      }
      .page {
        width: min(860px, 94vw);
        padding: 36px 0 60px;
      }
      h1 {
        margin: 0 0 20px;
        font-size: clamp(28px, 4vw, 40px);
        letter-spacing: 1px;
        text-align: center;
      }
      .header {
        display: grid;
        grid-template-columns: 48px 1fr 48px;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }
      .home {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        text-decoration: none;
        background: var(--accent);
        color: #fff;
        font-size: 18px;
        transition: transform 0.2s ease, background 0.2s ease;
      }
      .home:hover {
        transform: translateY(-2px);
        background: var(--accent-dark);
      }
      .home:active {
        transform: translateY(1px);
      }
      .ranking {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        text-decoration: none;
        background: var(--accent);
        color: #fff;
        font-size: 18px;
        transition: transform 0.2s ease, background 0.2s ease;
      }
      .ranking:hover {
        transform: translateY(-2px);
        background: var(--accent-dark);
      }
      .ranking:active {
        transform: translateY(1px);
      }
      h2 {
        margin: 26px 0 12px;
        font-size: 22px;
      }
      .round-card {
        background: var(--card);
        padding: 28px 34px;
        border-radius: 24px;
        box-shadow: var(--shadow);
        margin-top: 20px;
        scroll-margin-top: 18px;
      }
      .round-card.active-round {
        box-shadow: 0 0 0 4px #d64545, var(--shadow);
      }
      .match {
        display: grid;
        gap: 6px;
        padding: 12px 0;
        border-bottom: 1px solid #ebe6dc;
      }
      .match:last-child {
        border-bottom: none;
      }
      .court {
        font-weight: 700;
        letter-spacing: 0.5px;
        font-size: 20px;
      }
      .teams {
        font-weight: 600;
      }
      .line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        flex-wrap: wrap;
      }
      .result {
        display: grid;
        grid-template-columns: 80px 20px 80px;
        align-items: center;
        gap: 8px;
      }
      .result input {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #c9c3b9;
        text-align: center;
        font-size: 16px;
      }
      .result span {
        text-align: center;
        font-weight: 600;
      }
      .status {
        font-size: 13px;
        color: #4b4b4b;
        margin-top: 10px;
      }
      @media (max-width: 600px) {
        .page {
          padding: 24px 0 48px;
        }
        .round-card {
          padding: 22px 20px;
        }
        .result {
          grid-template-columns: 70px 20px 70px;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <div class="header">
        <a class="home" href="/" aria-label="Inicio">üè†</a>
        <h1>Resultados</h1>
        <a class="ranking" href="/clasificacion" aria-label="Ver clasificaci√≥n">üèÜ</a>
      </div>
      <div id="results"></div>
    </main>
    <script>
      const tournament = {{ tournament | tojson }};
      const resultsRoot = document.getElementById("results");

      function redirectHome() {
        window.location.replace("/");
      }

      function watchServer() {
        fetch("/api/ping", { cache: "no-store" })
          .then((response) => {
            if (!response.ok) {
              throw new Error("offline");
            }
          })
          .catch(() => {
            redirectHome();
          });
      }

      function computeActiveRoundIndex() {
        let activeRoundIndex = -1;
        tournament.rounds.forEach((round, roundIndex) => {
          const matches = round.matches || [];
          if (activeRoundIndex !== -1) {
            return;
          }
          if (!matches.length) {
            activeRoundIndex = roundIndex;
            return;
          }
          const allDone = matches.every((match) => {
            const result = match.result || {};
            return Number.isInteger(result.teamA) && Number.isInteger(result.teamB);
          });
          if (!allDone) {
            activeRoundIndex = roundIndex;
          }
        });
        if (activeRoundIndex === -1 && tournament.rounds.length) {
          activeRoundIndex = tournament.rounds.length - 1;
        }
        return activeRoundIndex;
      }

      function applyActiveRoundHighlight() {
        const activeRoundIndex = computeActiveRoundIndex();
        const sections = resultsRoot.querySelectorAll(".round-card");
        sections.forEach((section) => {
          const index = parseInt(section.dataset.roundIndex, 10);
          if (index === activeRoundIndex) {
            section.classList.add("active-round");
          } else {
            section.classList.remove("active-round");
          }
        });
      }

      function scrollToRoundContext() {
        const activeRoundIndex = computeActiveRoundIndex();
        if (activeRoundIndex < 0) {
          return;
        }
        const targetIndex = Math.max(activeRoundIndex - 1, 0);
        const target = resultsRoot.querySelector(
          `.round-card[data-round-index="${targetIndex}"]`
        );
        if (target) {
          target.scrollIntoView({ block: "start" });
        }
      }

      function render() {
        resultsRoot.innerHTML = "";
        tournament.rounds.forEach((round, roundIndex) => {
          const section = document.createElement("section");
          section.className = "round-card";
          section.dataset.roundIndex = roundIndex.toString();
          const heading = document.createElement("h2");
          heading.textContent = `Ronda ${roundIndex + 1}`;
          section.appendChild(heading);

          round.matches.forEach((match, matchIndex) => {
            const matchBlock = document.createElement("div");
            matchBlock.className = "match";

            const court = document.createElement("div");
            court.className = "court";
            court.textContent = `Pista ${matchIndex + 1}`;
            matchBlock.appendChild(court);

            const line = document.createElement("div");
            line.className = "line";

            const teams = document.createElement("div");
            teams.className = "teams";
            teams.textContent = `${match.teams[0].join(" + ")} vs ${match.teams[1].join(" + ")}`;
            line.appendChild(teams);

            const resultRow = document.createElement("div");
            resultRow.className = "result";

            const inputA = document.createElement("input");
            inputA.type = "number";
            inputA.min = "0";
            inputA.value = match.result && match.result.teamA !== null ? match.result.teamA : "";

            const inputB = document.createElement("input");
            inputB.type = "number";
            inputB.min = "0";
            inputB.value = match.result && match.result.teamB !== null ? match.result.teamB : "";

            const vs = document.createElement("span");
            vs.textContent = "-";

            resultRow.appendChild(inputA);
            resultRow.appendChild(vs);
            resultRow.appendChild(inputB);
            line.appendChild(resultRow);
            matchBlock.appendChild(line);

            function saveResult() {
              const teamAValue = inputA.value === "" ? null : parseInt(inputA.value, 10);
              const teamBValue = inputB.value === "" ? null : parseInt(inputB.value, 10);
              match.result = { teamA: teamAValue, teamB: teamBValue };
              const payload = {
                round_index: roundIndex,
                match_index: matchIndex,
                result: {
                  teamA: teamAValue,
                  teamB: teamBValue,
                },
              };
              fetch(`/api/tournaments/${tournament.id}/results`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              })
                .then((response) => response.json())
                .catch(() => {});
              applyActiveRoundHighlight();
            }

            inputA.addEventListener("change", saveResult);
            inputB.addEventListener("change", saveResult);

            section.appendChild(matchBlock);
          });

          if (round.bench && round.bench.length) {
            const bench = document.createElement("div");
            bench.className = "status";
            bench.textContent = `Descansan: ${round.bench.join(", ")}`;
            section.appendChild(bench);
          }

          resultsRoot.appendChild(section);
        });
        applyActiveRoundHighlight();
        scrollToRoundContext();
      }

      render();
      watchServer();
      setInterval(watchServer, 5000);

      history.pushState(null, "", window.location.href);
      window.addEventListener("popstate", () => {
        window.location.replace("/");
      });
    </script>
  </body>
</html>
